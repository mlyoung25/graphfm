extends layout

block head
  title Bubble Chart - D3v4

block content
  script(src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js')
  style.
    .bubble {
      fill-opacity: 1;
      stroke: #000;
      stroke-width: 1px;
    } 
    #BubbleChart div {
      background-color: white;
      color: black;
      padding: 5px;
      border-radius: 5px;
      pointer-events: none;
    }

  #BubbleChart
  script.
    // Create an array from the topArtists data.
    var topArtistsData = !{JSON.stringify(user.topArtists)};
    
    var svg = d3.select("#BubbleChart")
      .append("svg")
      .attr("width", 1500)
      .attr("height", 1500);

    var width = +svg.attr("width");
    var height = +svg.attr("height");
    var defs = svg.append('defs');
    
    topArtistsData.forEach((data, index) => {
      defs.append("pattern")
        .attr("id", "img-pattern-" + index)
        .attr("width", 1)
        .attr("height", 1)
        .append("image")
          .attr("xlink:href", data.imageUrl)
          .attr("width", data.radius * 2)  // assuming data.radius is used to define the size of the image (if not, provide the correct width and height)
          .attr("height", data.radius * 2);
    });

    var tooltip = d3.select("#BubbleChart")
    .append("div")
    .style("position", "absolute")
    .style("visibility", "hidden")
    .text("Default tooltip text");

    var circles = svg.selectAll("circle")
      .data(topArtistsData)
      .enter()
      .append("circle")
      .attr("id", function (d, i) { return "circle-" + i; });

    var circleAttributes = circles
      .attr("cx", function (d) { return d.x; })
      .attr("cy", function (d) { return d.y; })
      .attr("r", function (d) { return d.radius; })
      .style("fill", function (d, i) { return "url(#img-pattern-" + i + ")"; })
      .attr("class", "bubble")
      .on("dblclick", function (d) { 
        window.location.href = "/api/lastfm?artist=" + encodeURIComponent(d.name);
      })
      .on("mouseover", function(d){ 
        d3.select(this)
          .transition()
          .duration(200)
          .attr("r", d.radius * 1.1);  // enlargement factor 1.1
        tooltip.style("visibility", "visible");
        tooltip.text(d.name + ": " + d.playcount);
      })
      .on("mousemove", function(){
        tooltip.style("top", (d3.event.pageY-10)+"px")
        .style("left",(d3.event.pageX+10)+"px");
      })
      .on("mouseout", function(d){ 
        d3.select(this)
          .transition()
          .duration(200)
          .attr("r", d.radius);
        tooltip.style("visibility", "hidden");
      });

    var simulation = d3.forceSimulation(topArtistsData)
      .force("x", d3.forceX(width / 2).strength(0.05))
      .force("y", d3.forceY(height / 2).strength(0.05))
      .force('collide', d3.forceCollide().radius(function(d) { 
        return d.radius + 1;
      }));

    circles.call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended));

    simulation.nodes(topArtistsData)
      .on('tick', ticked);

    function ticked() {
      circles
          .attr("cx", function (d) { return d.x; })
          .attr("cy", function (d) { return d.y; })
    }

    function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }